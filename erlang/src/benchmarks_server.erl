-module(benchmarks_server).

%% this file was generated by grpc

-export([decoder/0,
         'Ready'/3,
         'Shutdown'/3,
         'PingPong'/3,
         'NetPingPong'/3,
         'ThroughputPingPong'/3,
         'NetThroughputPingPong'/3,
         'AtomicRegister'/3,
         'StreamingWindows'/3]).

-type 'PingPongRequest'() ::
    #{number_of_messages => integer()}.

-type 'ThroughputPingPongRequest'() ::
    #{messages_per_pair => integer(),
      pipeline_size => integer(),
      parallelism => integer(),
      static_only => boolean()}.

-type 'AtomicRegisterRequest'() ::
    #{read_workload => float() | infinity | '-infinity' | nan,
      write_workload => float() | infinity | '-infinity' | nan,
      partition_size => integer(),
      number_of_keys => integer()}.

-type 'StreamingWindowsRequest'() ::
    #{number_of_partitions => integer(),
      batch_size => integer(),
      window_size => string(),
      number_of_windows => integer(),
      window_size_amplification => integer()}.

-type 'TestResult'() ::
    #{sealed_value =>
          {success, 'TestSuccess'()} |
          {failure, 'TestFailure'()} |
          {not_implemented, 'NotImplemented'()}}.

-type 'TestSuccess'() ::
    #{number_of_runs => integer(),
      run_results => [float() | infinity | '-infinity' | nan]}.

-type 'TestFailure'() ::
    #{reason => string()}.

-type 'NotImplemented'() ::
    #{}.

-type 'ReadyRequest'() ::
    #{}.

-type 'ReadyResponse'() ::
    #{status => boolean()}.

-type 'ShutdownRequest'() ::
    #{force => boolean()}.

-type 'ShutdownAck'() ::
    #{}.

-spec decoder() -> module().
%% The module (generated by gpb) used to encode and decode protobuf
%% messages.
decoder() -> benchmarks.

%% RPCs for service 'BenchmarkRunner'

-spec 'Ready'(Message::'ReadyRequest'(), Stream::grpc:stream(), State::any()) ->
    {'ReadyResponse'(), grpc:stream()} | grpc:error_response().
%% This is a unary RPC
'Ready'(_Message, Stream, _State) ->
    io:fwrite("Got ready request.~n"),
    % io:fwrite("Stream was:~p ~n", [Stream]),
    % Stream2 = grpc:set_headers(Stream, #{
    %   <<"content-type">> => <<"application/grpc">>
    % }),
    % io:fwrite("Stream was later:~p ~n", [Stream2]),
    {#{status => true}, Stream}.

-spec 'Shutdown'(Message::'ShutdownRequest'(), Stream::grpc:stream(), State::any()) ->
    {'ShutdownAck'(), grpc:stream()} | grpc:error_response().
%% This is a unary RPC
'Shutdown'(_Message, Stream, _State) ->
    io:fwrite("Got shutdown request, but shouldn't handle this!~n"),
    {#{}, Stream}.

-spec 'PingPong'(Message::'PingPongRequest'(), Stream::grpc:stream(), State::any()) ->
    {'TestResult'(), grpc:stream()} | grpc:error_response().
%% This is a unary RPC
'PingPong'(Message, Stream, _State) ->
    io:fwrite("Got PingPong request.~n"),
    Res = benchmark_runner:run(ping_pong_bench,Message),
    io:fwrite("Finished PingPong run with ~p.~n", [Res]),
    Response = test_result:from_result(Res),
    io:fwrite("Sending PingPong response ~p.~n", [Response]),
    {Response, Stream}.

-spec 'NetPingPong'(Message::'PingPongRequest'(), Stream::grpc:stream(), State::any()) ->
    {'TestResult'(), grpc:stream()} | grpc:error_response().
%% This is a unary RPC
'NetPingPong'(_Message, Stream, _State) ->
    io:fwrite("Got NetPingPong request.~n"),
    {test_result:not_implemented(), Stream}.

-spec 'ThroughputPingPong'(Message::'ThroughputPingPongRequest'(), Stream::grpc:stream(), State::any()) ->
    {'TestResult'(), grpc:stream()} | grpc:error_response().
%% This is a unary RPC
'ThroughputPingPong'(_Message, Stream, _State) ->
    io:fwrite("Got ThroughputPingPong request.~n"),
    {test_result:not_implemented(), Stream}.

-spec 'NetThroughputPingPong'(Message::'ThroughputPingPongRequest'(), Stream::grpc:stream(), State::any()) ->
    {'TestResult'(), grpc:stream()} | grpc:error_response().
%% This is a unary RPC
'NetThroughputPingPong'(_Message, Stream, _State) ->
    io:fwrite("Got NetThroughputPingPong request.~n"),
    {test_result:not_implemented(), Stream}.

-spec 'AtomicRegister'(Message::'AtomicRegisterRequest'(), Stream::grpc:stream(), State::any()) ->
  {'TestResult'(), grpc:stream()} | grpc:error_response().
%% This is a unary RPC
'AtomicRegister'(_Message, Stream, _State) ->
  io:fwrite("Got AtomicRegister request.~n"),
  {test_result:not_implemented(), Stream}.

-spec 'StreamingWindows'(Message::'StreamingWindowsRequest'(), Stream::grpc:stream(), State::any()) ->
    {'TestResult'(), grpc:stream()} | grpc:error_response().
%% This is a unary RPC
'StreamingWindows'(_Message, Stream, _State) ->
    io:fwrite("Got StreamingWindows request.~n"),
  {test_result:not_implemented(), Stream}.
